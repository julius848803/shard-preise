<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merchant Rates</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f5f6f8;
  margin:0;
  padding:16px;
  color:#222;
}

h1 { text-align:center; margin-bottom:10px; }
h2 { margin:22px 0 8px; font-size:1.15rem; }

.section { max-width:900px; margin:0 auto 22px; }

.card {
  background:white;
  border:1px solid #ddd;
  border-radius:10px;
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
  font-size:0.95rem;
}

.stat-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
}

.stat {
  background:white;
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px;
  text-align:center;
  font-size:0.9rem;
}

.up { color:#0a8f2f; font-weight:600; }
.down { color:#c21d1d; font-weight:600; }

.range-buttons {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.range-buttons button {
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  background:white;
  font-size:0.9rem;
}

.range-buttons button.active {
  background:#222;
  color:white;
  border-color:#222;
}

.chart-box {
  background:white;
  border-radius:10px;
  padding:8px;
  border:1px solid #ddd;
  height:260px;
}

canvas { width:100% !important; height:100% !important; }

.table-wrap {
  overflow-x:auto;
  background:white;
  border-radius:10px;
  border:1px solid #ddd;
}

table {
  width:100%;
  border-collapse: collapse;
  min-width:520px;
}

th,td {
  padding:10px 12px;
  border-bottom:1px solid #eee;
  text-align:left;
  font-size:0.9rem;
}

th { background:#fafafa; font-weight:600; }
</style>
</head>
<body>

<h1>Merchant Rates</h1>

<div class="section">
<h2>Aktuelle Werte</h2>
<div id="current"></div>
</div>

<div class="section">
<h2>Zeitraum</h2>
<div class="range-buttons">
<button data-days="7" class="active">7 Tage</button>
<button data-days="14">14 Tage</button>
<button data-days="30">1 Monat</button>
<button data-days="90">3 Monate</button>
</div>
</div>

<div class="section">
<h2>Statistik</h2>
<div id="stats" class="stat-grid"></div>
</div>

<div class="section">
<h2>Verlauf (Diagramm)</h2>
<select id="itemSelect"></select>
<div class="chart-box">
  <canvas id="chart"></canvas>
</div>
</div>

<div class="section">
<h2>Verlauf (nur Ã„nderungen)</h2>
<div class="table-wrap">
<table id="historyTable">
<tr><th>Zeit</th><th>Item</th><th>Wert</th></tr>
</table>
</div>
</div>

<script>
let chart;
let fullHistory = [];
let currentDays = 7;

function pretty(name){
  return name.replace(/_/g," ");
}

fetch("history.json")
.then(r=>r.json())
.then(history=>{
  if(!history.length) return;
  fullHistory = history;

  renderCurrent(history.at(-1).data);
  initRangeButtons();
  initItems();
  applyRange(7);
});

function renderCurrent(latest){
  document.getElementById("current").innerHTML="";
  latest.forEach(item=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<span>${pretty(item.source)}</span><b>${item.exchangeRate.toFixed(2).replace(".",",")}</b>`;
    document.getElementById("current").appendChild(div);
  });
}

function initItems(){
  const items = [...new Set(fullHistory.flatMap(h => h.data.map(d => d.source)))];
  const select = document.getElementById("itemSelect");

  items.forEach(i=>{
    const o=document.createElement("option");
    o.value=i; 
    o.textContent=pretty(i);
    select.appendChild(o);
  });

  select.onchange = ()=>applyRange(currentDays);
}

function initRangeButtons(){
  document.querySelectorAll(".range-buttons button").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".range-buttons button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentDays = parseInt(btn.dataset.days);
      applyRange(currentDays);
    };
  });
}

function applyRange(days){
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);

  const filtered = fullHistory.filter(h => new Date(h.time) >= cutoff);
  const item = document.getElementById("itemSelect").value;

  buildStats(filtered, item);
  drawChart(filtered, item);
  buildTable(filtered);
}

function buildStats(history, item){
  const statsBox = document.getElementById("stats");
  statsBox.innerHTML="";

  const values = history.map(h => h.data.find(d=>d.source===item)?.exchangeRate).filter(v=>v!==undefined);
  if(values.length < 2) return;

  const start = values[0];
  const end = values[values.length-1];
  const min = Math.min(...values);
  const max = Math.max(...values);
  const diff = end - start;
  const percent = ((diff / start) * 100).toFixed(2);

  const stats = [
    ["Start", start],
    ["Ende", end],
    ["Min", min],
    ["Max", max],
    ["Differenz", diff.toFixed(2)],
    ["%", percent + " %"]
  ];

  stats.forEach(s=>{
    const d=document.createElement("div");
    d.className="stat";
    d.innerHTML=`<div>${s[0]}</div><b>${String(s[1]).replace(".",",")}</b>`;
    statsBox.appendChild(d);
  });
}

function drawChart(history, item){
  const labels = [];
  const values = [];

  history.forEach(h=>{
    const found = h.data.find(d=>d.source===item);
    if(found){
      labels.push(new Date(h.time).toLocaleDateString("de-DE"));
      values.push(found.exchangeRate);
    }
  });

  if(chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: pretty(item),
        data: values,
        borderWidth: 2,
        tension: 0.25
      }]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false
    }
  });
}

function buildTable(history){
  const table = document.getElementById("historyTable");
  table.innerHTML = "<tr><th>Zeit</th><th>Item</th><th>Wert</th></tr>";

  for(let i = history.length - 1; i > 0; i--){
    const cur = history[i];
    const prev = history[i-1];

    cur.data.forEach(item=>{
      const old = prev.data.find(p=>p.source===item.source);
      if(!old || old.exchangeRate !== item.exchangeRate){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${new Date(cur.time).toLocaleString("de-DE")}</td>
                      <td>${pretty(item.source)}</td>
                      <td>${item.exchangeRate.toFixed(2).replace(".",",")}</td>`;
        table.appendChild(tr);
      }
    });
  }
}
</script>

</body>
</html>
