<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPShards â€“ Kurse und Mehr</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#07080f;
  --card:#0d0f1a;
  --accent:#7c7cff;
  --accent2:#9b5cff;
  --text:#ffffff;
  --muted:#9aa0b4;
  --border:#1a1d2d;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif}
body{
  margin:0;
  background:radial-gradient(circle at top,#11142a,#05060c);
  color:var(--text);
}

header{
  position:sticky;top:0;z-index:50;
  display:flex;gap:14px;align-items:center;
  padding:14px 18px;
  background:rgba(7,8,15,.85);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
}

header b{font-size:18px;letter-spacing:.3px}
nav a{
  color:var(--muted);
  text-decoration:none;
  margin-left:12px;
  font-size:14px;
}
nav a.active, nav a:hover{color:var(--accent)}

.container{max-width:1000px;margin:auto;padding:18px}

.card{
  background:linear-gradient(180deg,#0f1220,#090b14);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 40px rgba(0,0,0,.5);
}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

h2{margin:4px 0 10px 0;font-size:18px}
.price{font-size:34px;font-weight:700}
.muted{color:var(--muted);font-size:13px}

.selector{display:flex;gap:10px;margin-bottom:10px}
.selector button{
  flex:1;
  background:#0b0d18;
  border:1px solid var(--border);
  color:white;
  padding:10px;
  border-radius:12px;
  font-size:15px;
}
.selector button.active{
  border-color:var(--accent);
  box-shadow:0 0 0 1px var(--accent) inset;
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  background:#090b14;
  border:1px solid var(--border);
  color:white;
  font-size:16px;
}

.stat{
  background:#090b14;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  text-align:center;
}
.stat b{font-size:18px}

canvas{width:100%!important;height:300px!important}

table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:9px;border-bottom:1px solid var(--border);text-align:left}
th{color:var(--muted)}
</style>
</head>

<body>

<header>
  <b>OPShards â€“ Kurse und Mehr</b>
  <nav>
    <a class="active" href="index.html">OPShards</a>
    <a href="ah-markt-rechner.html">OPMarkt & OPAH</a>
    <a href="more.html">Weiteres</a>
  </nav>
</header>

<div class="container">

<!-- KURSE -->
<div class="card grid2">
  <div>
    <div class="muted">Diamond Block</div>
    <div class="price" id="diaShard">â€“</div>
    <div class="muted">OPShards</div>
  </div>
  <div>
    <div class="muted">Netherite Ingot</div>
    <div class="price" id="netShard">â€“</div>
    <div class="muted">OPShards</div>
  </div>
</div>

<!-- RECHNER -->
<div class="card">
  <h2>OPShard Rechner</h2>
  <div class="selector">
    <button id="diaBtn" class="active">Diamond Block</button>
    <button id="netBtn">Netherite Ingot</button>
  </div>
  <input id="amount" type="number" value="1" min="0" step="1">
  <div style="margin-top:10px">
    <div class="muted" id="calcText">â€“</div>
    <div class="price" id="calcResult">â€“</div>
  </div>
</div>

<!-- STATISTIK -->
<div class="card">
  <h2>Statistik</h2>
  <div class="grid4">
    <div class="stat">Start<br><b id="sStart">â€“</b></div>
    <div class="stat">Min<br><b id="sMin">â€“</b></div>
    <div class="stat">Max<br><b id="sMax">â€“</b></div>
    <div class="stat">Î” %<br><b id="sPerc">â€“</b></div>
  </div>
</div>

<!-- CHART -->
<div class="card">
  <h2>Verlauf</h2>
  <canvas id="chart"></canvas>
</div>

<!-- TABELLE -->
<div class="card">
  <h2>Zahlenverlauf</h2>
  <table>
    <thead><tr><th>Zeit</th><th>Item</th><th>Wert</th></tr></thead>
    <tbody id="table"></tbody>
  </table>
</div>

</div>

<script>
const SHARD_API="https://api.opsucht.net/merchant/rates";
const HISTORY="history.json";

let mode="diamond_block",diaShard=0,netShard=0,chart,rows=[];

function label(s){return s==="diamond_block"?"Diamond Block":"Netherite Ingot"}

async function loadRates(){
  const shard=await fetch(SHARD_API).then(r=>r.json());
  diaShard=shard.find(i=>i.source==="diamond_block").exchangeRate;
  netShard=shard.find(i=>i.source==="netherite_ingot").exchangeRate;
  diaShardEl.textContent=diaShard.toFixed(2);
  netShardEl.textContent=netShard.toFixed(2);
  updateCalc();
}

async function loadHistory(){
  const raw=await fetch(HISTORY).then(r=>r.json());
  rows=[];
  raw.forEach(h=>h.data.forEach(d=>rows.push({
    time:new Date(h.time).toLocaleString("de-DE"),
    source:d.source,value:d.exchangeRate
  })));
  render();
}

function updateCalc(){
  const a=Number(amount.value||0);
  const val = mode==="diamond_block"?diaShard:netShard;
  calcText.textContent=`${a} ${label(mode)} =`;
  calcResult.textContent=(a*val).toFixed(2)+" OPShards";
}

function render(){
  const f = rows
    .filter(r=>r.source===mode)
    .map(r=>({ ...r, ts:new Date(r.time).getTime() }))
    .sort((a,b)=>a.ts-b.ts); // ðŸ‘‰ garantiert richtige Reihenfolge

  if(!f.length) return;

  const vals = f.map(r=>r.value);

  const start = vals[0];
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const perc = ((vals[vals.length-1]-start)/start*100);

  sStart.textContent = start.toFixed(2);
  sMin.textContent = min.toFixed(2);
  sMax.textContent = max.toFixed(2);
  sPerc.textContent = perc.toFixed(2)+" %";

  table.innerHTML = [...f].reverse().map(r=>`
    <tr>
      <td>${new Date(r.ts).toLocaleString("de-DE")}</td>
      <td>${label(r.source)}</td>
      <td>${r.value.toFixed(2)}</td>
    </tr>
  `).join("");

  if(chart) chart.destroy();

  chart = new Chart(chartEl,{
    type:"line",
    data:{
      labels: f.map(r =>
        new Date(r.ts).toLocaleString("de-DE",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})
      ),
      datasets:[{
        data: vals,
        borderColor:"#8b8bff",
        backgroundColor:"rgba(140,140,255,.18)",
        fill:true,
        tension:.35,
        pointRadius:2
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{legend:{display:false}},
      scales:{
        x:{
          ticks:{
            color:"#9aa0b4",
            maxTicksLimit:6,      // ðŸ‘‰ verhindert Text-MÃ¼ll
            autoSkip:true,
            maxRotation:0
          },
          grid:{display:false}
        },
        y:{
          ticks:{color:"#9aa0b4"},
          grid:{color:"rgba(255,255,255,.04)"}
        }
      }
    }
  });
}


diaBtn.onclick=()=>{mode="diamond_block";diaBtn.classList.add("active");netBtn.classList.remove("active");updateCalc();render()}
netBtn.onclick=()=>{mode="netherite_ingot";netBtn.classList.add("active");diaBtn.classList.remove("active");updateCalc();render()}
amount.oninput=updateCalc;

const diaShardEl=document.getElementById("diaShard");
const netShardEl=document.getElementById("netShard");
const chartEl=document.getElementById("chart");
const table=document.getElementById("table");
const sStart=document.getElementById("sStart");
const sMin=document.getElementById("sMin");
const sMax=document.getElementById("sMax");
const sPerc=document.getElementById("sPerc");
const calcText=document.getElementById("calcText");
const calcResult=document.getElementById("calcResult");

loadRates();
loadHistory();
</script>
</body>
</html>
