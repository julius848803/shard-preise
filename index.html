<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>OPSUCHT – Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;
  background:radial-gradient(circle at top,#0f1a3a,#050814);
  color:#fff
}

/* HEADER */
header{
  max-width:1100px;
  margin:20px auto;
  padding:0 16px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
header strong{font-size:18px}
nav{display:flex;gap:10px}
nav a{
  flex:1;
  text-align:center;
  padding:10px 14px;
  border-radius:999px;
  text-decoration:none;
  font-weight:600;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  color:#fff
}
nav a.active{background:#fff;color:#000}

/* CARD */
.card{
  max-width:1100px;
  margin:20px auto;
  padding:20px;
  border-radius:20px;
  background:linear-gradient(180deg,#0d1535,#070b1d);
  box-shadow:0 20px 60px rgba(0,0,0,.6)
}

/* INFO */
.info-bar{
  margin-bottom:14px;
  padding:12px 16px;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  font-size:14px
}

/* SWITCHES */
.switch{display:grid;gap:12px;margin-bottom:14px}
.switch-items{grid-template-columns:1fr 1fr}
.switch-days{grid-template-columns:repeat(3,1fr)}
.switch button{
  padding:14px;
  border-radius:999px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
  color:#fff;
  font-weight:600;
  cursor:pointer
}
.switch button.active{background:#fff;color:#000}

/* STATISTIK */
.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px
}
.stat{
  background:rgba(255,255,255,.05);
  border-radius:14px;
  padding:14px;
  text-align:center
}
.stat small{opacity:.7;font-size:13px}
.stat strong{display:block;margin-top:6px;font-size:22px}

/* CHART */
.chart-wrap{height:260px;margin-bottom:16px}

/* TABLE */
table{width:100%;border-collapse:collapse}
thead th{
  text-align:left;
  opacity:.7;
  font-size:13px;
  padding:8px 0
}
tbody td{
  padding:8px 0;
  border-top:1px solid rgba(255,255,255,.08)
}

/* MOBILE */
@media(max-width:700px){
  header{flex-direction:column;gap:12px}
  nav{width:100%}
  .stats{grid-template-columns:1fr 1fr}
  .switch-items,.switch-days{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>
  <strong>OPSUCHT – Tool</strong>
  <nav>
    <a class="active" href="index.html">OPShards</a>
    <a href="ah-markt-rechner.html">Markt & AH</a>
    <a href="more.html">Weiteres</a>
  </nav>
</header>

<section class="card">
  <div class="info-bar">
    ℹ️ Updates täglich von <b>5–8 Uhr</b> · alle <b>15 Minuten</b>
  </div>

  <div class="switch switch-items">
    <button class="active" data-item="diamond_block">Diamond Block</button>
    <button data-item="netherite_ingot">Netherite Ingot</button>
  </div>

  <div class="switch switch-days">
    <button class="active" data-days="7">7 Tage</button>
    <button data-days="14">14 Tage</button>
    <button data-days="30">30 Tage</button>
  </div>
</section>

<section class="card">
  <h2>Statistik</h2>
  <div class="stats">
    <div class="stat"><small>Aktueller Wert</small><strong id="statCurrent">–</strong></div>
    <div class="stat"><small>Min</small><strong id="statMin">–</strong></div>
    <div class="stat"><small>Max</small><strong id="statMax">–</strong></div>
    <div class="stat"><small>Δ %</small><strong id="statDelta">–</strong></div>
  </div>
</section>

<section class="card">
  <h2>Verlauf</h2>
  <div class="chart-wrap"><canvas id="chart"></canvas></div>

  <table>
    <thead><tr><th>Datum</th><th>Wert</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>
</section>

<script>
let currentItem="diamond_block";
let currentDays=7;
let chart;

document.querySelectorAll("[data-item]").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("[data-item]").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentItem=b.dataset.item;
    loadHistory();
  }
});

document.querySelectorAll("[data-days]").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("[data-days]").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentDays=+b.dataset.days;
    loadHistory();
  }
});

async function loadHistory(){
  const res=await fetch("history.json");
  const raw=await res.json();
  let rows=[];

  raw.forEach(e=>{
    e.data.forEach(d=>{
      if(d.source===currentItem){
        rows.push({ts:new Date(e.time),value:d.exchangeRate});
      }
    });
  });

  rows.sort((a,b)=>a.ts-b.ts);
  const cutoff=Date.now()-currentDays*86400000;
  rows=rows.filter(r=>r.ts>=cutoff);
  if(!rows.length) return;

  const vals=rows.map(r=>r.value);
  statCurrent.textContent=rows.at(-1).value.toFixed(2);
  statMin.textContent=Math.min(...vals).toFixed(2);
  statMax.textContent=Math.max(...vals).toFixed(2);

  const delta=((rows.at(-1).value-rows[0].value)/rows[0].value)*100;
  statDelta.textContent=delta.toFixed(2)+" %";
  statDelta.style.color=delta<0?"#f87171":"#4ade80";

  renderChart(rows);
  renderTable(rows);
}

function renderChart(rows){
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{
      labels:rows.map(r=>r.ts),
      datasets:[{
        data:rows.map(r=>r.value),
        borderColor:"#7c83ff",
        backgroundColor:"rgba(124,131,255,.15)",
        fill:true,
        tension:.4,
        pointRadius:3
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          type:"time",
          time:{unit:"day",displayFormats:{day:"dd. MMM"}},
          ticks:{color:"#aaa"}
        },
        y:{ticks:{color:"#aaa"},grace:"15%"}
      },
      plugins:{legend:{display:false}}
    }
  });
}

function renderTable(rows){
  tableBody.innerHTML="";
  rows.slice().reverse().forEach(r=>{
    tableBody.innerHTML+=
      `<tr><td>${r.ts.toLocaleDateString("de-DE")}</td><td>${r.value.toFixed(2)}</td></tr>`;
  });
}

loadHistory();
</script>

</body>
</html>