name: Merchant Rates Logger

on:
  schedule:
    # 11:10 Uhr deutscher Zeit (UTC+1) = 10:10 Uhr UTC
    - cron: "10 10 * * *"
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch API
        run: |
          curl -s https://api.opsucht.net/merchant/rates > latest.json

      - name: Compare & store
        run: |
          node << 'EOF'
          const fs = require("fs");

          const latest = JSON.parse(fs.readFileSync("latest.json"));
          const now = new Date().toISOString();

          let history = [];
          if (fs.existsSync("history.json")) {
            history = JSON.parse(fs.readFileSync("history.json"));
          }

          const last = history.at(-1);

          if (!last || JSON.stringify(last.data) !== JSON.stringify(latest)) {
            history.push({ time: now, data: latest });
            fs.writeFileSync("history.json", JSON.stringify(history, null, 2));
            console.log("Änderung gespeichert");
          } else {
            console.log("Keine Änderung");
          }
          EOF

      - name: Commit history
        run: |
          git config user.name "rates-bot"
          git config user.email "rates@bot.local"
          git add history.json
          git commit -m "Update rates history" || exit 0
          git push